# CLAUDE.md

This file provides guidance to Claude Code when working with the @repo-md/processor-core package.

## Overview

**@repo-md/processor-core** is a lightweight, modular markdown processor with a plugin-based architecture. It converts Obsidian-style markdown vaults to structured JSON, with extensible support for image processing, embeddings, and database generation via plugins.

## Key Design Principles

1. **Processor = Single File Generator**: All output files are generated by the processor
2. **Worker = Orchestrator**: Workers only configure and run the processor
3. **Plugins Have Dependencies**: Some plugins require others (e.g., similarity requires textEmbedder)
4. **Separate Concerns**: Text embeddings and image embeddings are separate plugins
5. **Lightweight Core**: No heavy dependencies - plugins bring their own (Sharp, Transformers, etc.)

## Commands

```bash
npm run build        # Build TypeScript to dist/
npm run dev          # Watch mode for development
npm run test         # Run all tests with Vitest
npm run test:watch   # Watch mode for tests
npm run typecheck    # Type checking without emit
```

## Architecture

### Plugin System

Plugins are registered with the processor and initialized in dependency order:

```typescript
import { Processor } from '@repo-md/processor-core';
import { SharpImageProcessor } from '@repo-md/plugin-image-sharp';
import { TransformersTextEmbedder } from '@repo-md/plugin-embed-transformers';

const processor = new Processor({
  dir: { input: './vault', output: './dist' },
  plugins: {
    imageProcessor: new SharpImageProcessor(),
    textEmbedder: new TransformersTextEmbedder(),
  }
});

await processor.initialize();
const result = await processor.process();
await processor.dispose();
```

### Plugin Types

| Plugin Name | Interface | Purpose |
|------------|-----------|---------|
| `imageProcessor` | `ImageProcessorPlugin` | Image resizing, format conversion |
| `textEmbedder` | `TextEmbeddingPlugin` | Generate text embeddings |
| `imageEmbedder` | `ImageEmbeddingPlugin` | Generate image embeddings |
| `similarity` | `SimilarityPlugin` | Compute post similarity (requires textEmbedder) |
| `database` | `DatabasePlugin` | Generate SQLite database |
| `mermaidRenderer` | `MermaidRendererPlugin` | Render Mermaid diagrams |

### Directory Structure

```
src/
├── index.ts              # Main exports
├── processor.ts          # Core Processor class
├── types/
│   ├── config.ts         # Configuration types
│   ├── post.ts           # Post/content types
│   ├── media.ts          # Media types
│   ├── issues.ts         # Issue tracking types
│   └── results.ts        # Processing result types
├── plugins/
│   ├── types.ts          # Plugin interfaces
│   ├── manager.ts        # PluginManager with dependency resolution
│   └── defaults.ts       # Default no-op plugins
├── process/
│   ├── processContent.ts # Content processing pipeline
│   └── processMedia.ts   # Media processing
├── services/
│   └── issueCollector.ts # Issue collection service
├── remark/               # Remark plugins for markdown
└── rehype/               # Rehype plugins for HTML
```

## Output Structure

The processor generates all output files:

```
dist/
├── posts.json                    # All posts with metadata
├── posts-slug-map.json           # slug → hash mapping
├── posts-path-map.json           # path → hash mapping
├── medias.json                   # All media with sizes (plural for client compatibility)
├── _posts/                       # Individual post JSON files
│   └── {hash}.json
├── _media/                       # Processed media files
│   └── {hash}.{ext}
│
# Plugin-generated files:
├── posts-embedding-hash-map.json # If textEmbedder
├── media-embedding-hash-map.json # If imageEmbedder
├── posts-similarity.json         # If similarity plugin
├── repo.db                       # If database plugin
└── processor-issues.json         # Issue report
```

## Creating Plugins

Plugins must implement the corresponding interface:

```typescript
import type { ImageProcessorPlugin, PluginContext } from '@repo-md/processor-core';

export class MyImageProcessor implements ImageProcessorPlugin {
  readonly name = 'imageProcessor' as const;
  private context!: PluginContext;

  async initialize(context: PluginContext): Promise<void> {
    this.context = context;
  }

  isReady(): boolean {
    return !!this.context;
  }

  async dispose(): Promise<void> {
    // Cleanup
  }

  // Implement required methods...
}
```

For plugins with dependencies:

```typescript
export class MySimilarityPlugin implements SimilarityPlugin {
  readonly name = 'similarity' as const;
  readonly requires = ['textEmbedder'] as const;  // Declare dependency

  async initialize(context: PluginContext): Promise<void> {
    // Access required plugin
    const embedder = context.getPlugin<TextEmbeddingPlugin>('textEmbedder');
    if (!embedder) {
      throw new Error('SimilarityPlugin requires textEmbedder plugin');
    }
  }
}
```

## Testing

Tests are co-located with source files using Vitest:

```bash
npm run test              # Run all tests
npm run test -- --grep slug  # Run specific tests
```

Test fixtures are in `test/fixtures/`:

```
test/fixtures/
├── vault-minimal/        # Simple vault for basic tests
├── vault-with-media/     # Vault with images
├── vault-with-links/     # Vault with wiki-links
└── expected-outputs/     # Golden master outputs
```

## Key Types

```typescript
// Processing configuration
interface ProcessConfig {
  dir: { input: string; output?: string };
  plugins?: {
    imageProcessor?: ImageProcessorPlugin;
    textEmbedder?: TextEmbeddingPlugin;
    imageEmbedder?: ImageEmbeddingPlugin;
    similarity?: SimilarityPlugin;
    database?: DatabasePlugin;
  };
  imageSizes?: ImageSize[];
  imageFormat?: 'webp' | 'avif' | 'jpeg';
  imageQuality?: number;
}

// Processing result
interface ProcessResult {
  posts: ProcessedPost[];
  media: ProcessedMedia[];
  textEmbeddings?: EmbeddingsMetadata;
  imageEmbeddings?: EmbeddingsMetadata;
  similarity?: SimilarityResult;
  database?: DatabaseResult;
  issues: IssueReport;
}
```

## Cover Image Resolution

The processor automatically resolves cover images from frontmatter into a top-level `cover` property on posts. This keeps the frontmatter unchanged while providing resolved media information.

### Supported Frontmatter Fields

The processor checks these fields in order: `cover`, `image`, `thumbnail`, `coverImage`, `cover_image`

### URL Generation

The `url` field is only populated when `media.domain` is configured:

```typescript
const processor = new Processor({
  config: {
    dir: { input: './vault', output: './dist' },
    media: {
      domain: 'https://static.repo.md/org/project',
      pathPrefix: '/_media', // default
    },
  },
});
```

### Output Structure

**When cover image is found:**
```json
{
  "title": "My Post",
  "frontmatter": { "cover": "media/image.jpg" },
  "cover": {
    "original": "media/image.jpg",
    "path": "_media/abc123.webp",
    "url": "https://static.repo.md/org/project/_media/abc123.webp",
    "hash": "abc123def456...",
    "width": 1200,
    "height": 675,
    "sizes": [
      { "suffix": "xs", "path": "_media/abc123-xs.webp", "url": "https://static.repo.md/org/project/_media/abc123-xs.webp", "width": 100, "height": 56 },
      { "suffix": "sm", "path": "_media/abc123-sm.webp", "url": "https://static.repo.md/org/project/_media/abc123-sm.webp", "width": 300, "height": 169 }
    ]
  }
}
```

**When cover image is NOT found:**
```json
{
  "title": "My Post",
  "frontmatter": { "cover": "media/missing.jpg" },
  "cover": {
    "original": "media/missing.jpg",
    "error": "Cover image not found: \"media/missing.jpg\""
  }
}
```

**When no cover specified:** The `cover` property is omitted entirely.

### Type Definitions

```typescript
interface PostCover {
  original: string;      // Original path from frontmatter
  path: string;          // Output path relative to dist
  url?: string;          // Full URL if domain configured
  hash?: string;         // Content hash
  width?: number;        // Image width
  height?: number;       // Image height
  sizes?: PostCoverSize[]; // Responsive variants
}

interface PostCoverError {
  original: string;      // Original path from frontmatter
  error: string;         // Error message
}

// On ProcessedPost:
cover?: PostCover | PostCoverError;
```

## Dependencies

**Production** (minimal):
- `unified`, `remark-*`, `rehype-*` - Markdown pipeline
- `gray-matter` - Frontmatter parsing
- `@sindresorhus/slugify` - Slug generation

**No heavy dependencies** - Sharp, Playwright, ML libraries are in separate plugins.

## Relationship to Other Packages

- **@repo-md/processor** (legacy): Old all-in-one processor with Sharp/Playwright built-in
- **@repo-md/worker-ts**: Uses processor-core with plugins for full pipeline
- **@repo-md/plugin-***: Plugins that extend processor-core capabilities
