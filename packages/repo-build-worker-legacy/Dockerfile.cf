# Cloudflare Containers Dockerfile
# Optimized for Cloudflare Workers platform
# https://developers.cloudflare.com/containers/

FROM node:20-slim

WORKDIR /app

# Install system dependencies (minimal set for CF Containers)
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    git \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Copy package files
COPY package*.json ./

# Install Node.js dependencies
# Note: Skip native modules that don't work in CF Workers
# - better-sqlite3: Use D1 or Neon PostgreSQL instead
# - sharp: Use Cloudflare Images API instead
# - @huggingface/transformers: Use OpenAI API instead
RUN npm ci --omit=dev --ignore-scripts || npm install --omit=dev --ignore-scripts

# Copy application code
COPY . .

# Set environment variables for CF Containers
ENV NODE_ENV=production
ENV PORT=8080
ENV SKIP_EMBEDDINGS=true
ENV PURGE_TMP_DIR=false

# Create temp directory for job processing
RUN mkdir -p /tmp/repo.md

# Healthcheck endpoint
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
  CMD node -e "require('http').get('http://localhost:8080/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"

# Expose the default container port
EXPOSE 8080

# Start the application
# CF Containers expect the service to listen on $PORT (default 8080)
CMD ["node", "src/worker.js"]
